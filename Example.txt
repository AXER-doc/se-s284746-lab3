<!-- build.xml -->
<?xml version="1.0" ?>
<project name="MSPLab3" default="build">
    <property file="build.properties"/>

    <path id="classpath.sources">
        <fileset dir="${dir.libs}" includes="**/*.jar"/>
    </path>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${dir.libs}/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>

    <target name="compile">
        <mkdir dir="${dir.compiled.classes}"/>
        <mkdir dir="${dir.compiled.tests}"/>

        <echo level="info">Build java classes</echo>
        <javac destdir="${dir.compiled.classes}" includeantruntime="false"
               target="11" source="11" verbose="true">
            <src path="${dir.src.main}"/>
            <classpath>
                <pathelement location="${dir.compiled.classes}"/>
                <path refid="classpath.sources"/>
            </classpath>
        </javac>

        <echo level="info">Build test classes</echo>
        <javac destdir="${dir.compiled.tests}" includeantruntime="false"
               target="11" source="11" verbose="true">
            <src path="${dir.src.test}"/>
            <classpath>
                <pathelement location="${dir.compiled.classes}"/>
                <path refid="classpath.sources"/>
            </classpath>
        </javac>
    </target>

    <target name="build" depends="compile">
        <jar destfile="${file.jar}" basedir="${dir.compiled.classes}"
             compress="false" index="true">
            <manifest>
                <attribute name="Main-Class" value="info.mermakov.dev.itmo.msp3.Application"/>
            </manifest>
            <zipgroupfileset dir="${dir.libs}" includes="*.jar"/>
            <fileset dir="${dir.src.resources}">
                <include name="*.xml"/>
            </fileset>
        </jar>

    </target>

    <target name="clean">
        <delete dir="${dir.compiled}"/>
    </target>

    <target name="test" depends="build">
        <junitlauncher printsummary="true" haltonfailure="true">
            <classpath>
                <path refid="classpath.sources"/>
                <pathelement location="${dir.compiled.classes}"/>
                <pathelement location="${dir.compiled.tests}"/>
            </classpath>
            <testclasses>
                <fileset dir="${dir.compiled.tests}">
                    <include name="**/*.class"/>
                </fileset>
            </testclasses>
        </junitlauncher>
    </target>

    <target name="xml">
        <xmlvalidate failonerror="no" warn="yes">
            <fileset dir="." includes="**/*.xml"/>
            <attribute name="http://xml.org/sax/features/validation" value="true"/>
            <attribute name="http://apache.org/xml/features/validation/schema" value="true"/>
            <attribute name="http://xml.org/sax/features/namespaces" value="true"/>
        </xmlvalidate>
    </target>

    <target name="history">
        <exec executable="svn" output="svnlog.out">
            <arg line="info --show-item last-changed-revision --no-newline"/>
        </exec>

        <var name="svn.revision" unset="true"/>

        <loadfile property="svn.revision" srcfile="svnlog.out"/>

        <math result="svn.revision" operand1="${svn.revision}" operand2="0" operation="-" datatype="int"/>

        <if>
            <equals arg1="${svn.revision}" arg2="0"/>
            <then></then>
            <else>
                <math result="svn.revision" operand1="${svn.revision}" operand2="1" operation="-" datatype="int"/>
            </else>
        </if>

        <echo level="info">${svn.revision}</echo>

        <trycatch>
            <try>
                <runtarget target="build"/>
                <math result="svn.revision" operand1="${svn.revision}" operand2="1" operation="+" datatype="int"/>
                <exec executable="svn" output="${file.diff}">
                    <arg line="diff -r${svn.revision} ${svn.repository}"/>
                </exec>
            </try>
            <catch>
                <echo>Build failed</echo>
                <if>
                    <equals arg1="${svn.revision}" arg2="-1"/>
                    <then>
                        <fail>Impossible to build</fail>
                    </then>
                </if>
                <exec executable="svn">
                    <arg line="cleanup"/>
                </exec>
                <exec executable="svn">
                    <arg line="up --accept theirs-full -r${svn.revision}"/>
                </exec>
                <sleep seconds="2"/>
                <runtarget target="history"/>
            </catch>
        </trycatch>
    </target>
</project>

<!-- build.properties -->
dir.libs=libs
dir.compiled=target
dir.compiled.classes=${dir.compiled}/classes
dir.compiled.tests=${dir.compiled}/tests
dir.src=src
dir.src.main=${dir.src}/main/java
dir.src.resources=${dir.src}/main/resources
dir.src.test=${dir.src}/test/java
file.jar=${dir.compiled}/MSP3Lab3.jar
file.diff=${dir.compiled}/svn.diff
svn.repository=https://github.com/ermakovm/msp3